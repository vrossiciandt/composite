name: 'Extract Values from Structured File'
description: 'Extract one or multiple values from structured files (YAML or JSON)'
inputs:
  file-path:
    description: 'Path to the file containing the data'
    required: true
  file-type:
    description: 'yaml or json'
    required: true
  attributes:
    description: 'JSON object with attribute names as keys and paths as values. Example: {"version": "version", "name": "metadata.name"}. For single value, use: {"value": "version"}'
    required: true
outputs:
  values:
    description: 'JSON object with all extracted values'
    value: ${{ steps.extract.outputs.values }}
  count:
    description: 'Number of values successfully extracted'
    value: ${{ steps.extract.outputs.count }}
  status:
    description: 'Status of extraction (success/failed)'
    value: ${{ steps.extract.outputs.status }}
runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [ -z "${{ inputs.file-path }}" ] || [ -z "${{ inputs.attributes }}" ]; then
          echo "Error: file-path and attributes are required"
          exit 1
        fi
        
        if [ ! -f "${{ inputs.file-path }}" ]; then
          echo "Error: File not found at ${{ inputs.file-path }}"
          exit 1
        fi

    - name: Extract values
      id: extract
      shell: bash
      run: |
        FILE_PATH="${{ inputs.file-path }}"
        FILE_TYPE="${{ inputs.file-type }}"
        ATTRIBUTES='${{ inputs.attributes }}'
        
        echo "ğŸ“„ Extracting from: $FILE_PATH"
        echo "ğŸ“‹ File type: $FILE_TYPE"
        
        # Inicializar objeto JSON resultado
        RESULT="{}"
        COUNT=0
        ERROR_COUNT=0
        
        # Iterar sobre cada atributo definido
        ATTRIBUTE_KEYS=$(echo "$ATTRIBUTES" | jq -r 'keys[]')
        
        while IFS= read -r key; do
          ATTRIBUTE_KEY=$(echo "$ATTRIBUTES" | jq -r ".\"$key\"")
          
          echo "  â”œâ”€ Extracting: $key (path: $ATTRIBUTE_KEY)"
          
          case "$FILE_TYPE" in
            yaml|yml)
              EXTRACTED=$(yq eval ".$ATTRIBUTE_KEY" "$FILE_PATH" 2>&1)
              ;;
            json)
              EXTRACTED=$(jq -r ".$ATTRIBUTE_KEY" "$FILE_PATH" 2>&1)
              ;;
            *)
              echo "    âŒ Unsupported file type: $FILE_TYPE"
              exit 1
              ;;
          esac
          
          if [ -z "$EXTRACTED" ] || [ "$EXTRACTED" = "null" ]; then
            echo "    âš ï¸  Not found or empty"
            RESULT=$(echo "$RESULT" | jq --arg k "$key" '.[$k] = null')
            ERROR_COUNT=$((ERROR_COUNT + 1))
          else
            echo "    âœ“ Found: $EXTRACTED"
            RESULT=$(echo "$RESULT" | jq --arg k "$key" --arg v "$EXTRACTED" '.[$k] = $v')
            COUNT=$((COUNT + 1))
          fi
        done <<< "$ATTRIBUTE_KEYS"
        
        echo ""
        echo "âœ“ Extraction complete"
        
        # Escapar resultado para output
        RESULT_ESCAPED=$(echo "$RESULT" | jq -c .)
        echo "values=$RESULT_ESCAPED" >> $GITHUB_OUTPUT
        echo "count=$COUNT" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Output summary
      shell: bash
      run: |
        echo "ğŸ“Š Extraction Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "File: ${{ inputs.file-path }}"
        echo "Type: ${{ inputs.file-type }}"
        echo "Values extracted: ${{ steps.extract.outputs.count }}"
        echo ""
        echo "Results:"
        echo "${{ steps.extract.outputs.values }}" | jq '.'